import subprocess, locale, re

def safe_decode(b: bytes) -> str:
    """Decode bytes safely using UTF-8 or system locale fallback."""
    if not b:
        return ""
    try:
        return b.decode("utf-8").strip()
    except LookupError:
        enc = locale.getpreferredencoding(False) or "utf-8"
        return b.decode(enc, errors="ignore").strip()

def extract_value(s: str) -> str:
    """Extract clean value from CLI output like 'User ID : xyz' or 'PASSWORD=abc'."""
    if not s:
        return ""
    line = ""
    for L in s.splitlines():
        L = L.strip()
        if L:
            line = L
    if not line:
        return ""
    if ":" in line:
        line = line.split(":", 1)[-1].strip()
    elif "=" in line:
        line = line.split("=", 1)[-1].strip()
    return line

def get_connection_details(logonmgr_file: str, dbType: str = ""):
    """Fetch server, userid, password, database from logonmgr tool."""
    cmds = {
        "server":   ["logonmgr", "server",   logonmgr_file],
        "userid":   ["logonmgr", "userid",   logonmgr_file],
        "password": ["logonmgr", "password", "decrypt", logonmgr_file],
        "database": ["logonmgr", "database", logonmgr_file],
    }

    result = {}
    for key, cmd in cmds.items():
        try:
            proc = subprocess.run(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
            raw = safe_decode(proc.stdout) or safe_decode(proc.stderr)
            value = extract_value(raw)
            result[key] = value if value else None
        except Exception as e:
            result[key] = None
            print(f"Failed to run {cmd}: {e}")

    return result
